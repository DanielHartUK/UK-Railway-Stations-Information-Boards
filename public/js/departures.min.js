var rows,sIDs=[],rowsPerPage=27,pages=5,departures=rowsPerPage*pages;if(getQueryVariable("page"))var page=getQueryVariable("page");else page=1;var tsCache,x,stationCode=getQueryVariable("station"),responseError=!1;function getTrains(e){sIDs=[],rows=0;var r=0;$.get("get/get.php?station="+stationCode+"&rows="+departures+"?type=departures",function(a){if(console.log(a),$(".departureEntry.error, .departureEntry.noDepartures").remove(),responseError=!1,$(".errorIcon").hide(),null!=a.GetStationBoardResult){if(0===$(".noDepartures").length)if(null!=a.GetStationBoardResult.nrccMessages){for(rows+=9,i=0;i<6;i++)$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre"></p></div></div>');for($(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre"><strong>Special Notices</strong></p></div></div>'),$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre">==========================================</p></div></div>'),$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre"></p></div></div>'),nrccMessage=a.GetStationBoardResult.nrccMessages.message._,null!=nrccMessage.match(/<a\s+(?:[^>]*?\s+)?href="([^"]*)">([^"]*)<\/a>/gi)&&(nrccMessage=nrccMessage.replace(/in (?=<a\s+(?:[^>]*?\s+)?href="([^"]*)">([^"]*)<\/a>)/gi,"at "),nrccMessage=nrccMessage.replace(/<a\s+(?:[^>]*?\s+)?href="([^"]*)">([^"]*)<\/a>/gi,$(nrccMessage.match(/<a\s+(?:[^>]*?\s+)?href="([^"]*)">([^"]*)<\/a>/gi)[0]).attr("href").match(/http:\/\/([^\/,\s]+\.[^\/,\s]+?)(?=\/|,|\s|$|\?|#)/gi)[0].replace("http://",""))),nrccMessage=nrccMessage.replace(/<[^>]*>/g,"")+" ";nrccMessage.length>0;){var t=nrccMessage.substr(0,50);-1!=t.lastIndexOf(" ")?lastInd=t.lastIndexOf(" "):lastInd=t.length-1,""==(t=t.substr(0,Math.min(t.length,lastInd)))&&(t=nrccMessage),nrccMessage=nrccMessage.replace(t,"")," "!=t&&($(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre">'+t+"</p></div></div>"),rows++)}}else{for(rows+=9,i=0;i<7;i++)$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre"></p></div></div>');$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre">Welcome to</p></div></div>'),$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre">'+a.GetStationBoardResult.locationName+"</p></div></div>")}}else"No response"===a&&(responseError=!0,$(".errorIcon").show(),null!=tsCache?a=tsCache:(rows+=3,$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">No reponse recieved.</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">Check station code is correct</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">and rate limit is not exceeded.</p></div></div>')));if("No response"!=a&&a.length>0){tsCache=a,$.each(a,function(e,a){if(++r<=rowsPerPage*(page-1));else{if(r>rowsPerPage*page)return!1;var t=sanitizeID(a.serviceID);if(rows++,sIDs.push(a.serviceID),0===$("#"+t).length){var s='<div class="departureEntry" id="'+t+'" data-serviceID="'+a.serviceID+'" data-operator="'+a.operator+'">';if(s+='<div class="departureRow">',s+='<p class="std">',null!=a.std&&(s+=a.std),s+="</p>",s+='<p class="destinationName">',null!=a.destination.location)if(a.destination.location.length>1){var n=0;$.each(a.destination.location,function(e,r){0!=n&&(s+=" &amp; "),s+='<a href="?station='+r.crs+'">'+r.locationName+"</a>",n++})}else s+='<a href="?station='+a.destination.location.crs+'">'+a.destination.location.locationName+"</a>";s+="</p>",s+='<p class="platform">',"train"!=a.serviceType?s+=a.serviceType:null!=a.platform&&(s+=a.platform),s+="</p>",s+='<p class="etd">',null!=a.etd&&(s+=a.etd),s+="</p>",s+="</div>",s+="</div>",$(".departuresList").append(s)}else{var i=$("#"+t),o="";if(null!=a.destination.location)if(o="",a.destination.location.length>1){n=0;$.each(a.destination.location,function(e,r){0!=n&&(o+=" &amp; "),o+='<a href="?station='+r.crs+'">'+r.locationName+"</a>",n++})}else o+='<a href="?station='+a.destination.location.crs+'">'+a.destination.location.locationName+"</a>";$(i).find(".destinationName").html()!=o.replace(" & "," &amp; ")&&$(i).find(".destinationName").html(o).addClass("departureUpdated"),o="","train"!=a.serviceType?o=a.serviceType:null!=a.platform&&(o=a.platform),$(i).find(".platform").html()!=o&&$(i).find(".platform").html(o).addClass("departureUpdated"),o="",null!=a.etd&&(o=a.etd),$(i).find(".etd").html()!=o&&$(i).find(".etd").html(o)}}});var s=Math.ceil(a.length/rowsPerPage);$(".page").text("Page "+page+" of "+s)}for($.each($(".departureEntry:not(.empty, .error, .noDepartures)"),function(e,r){var a=$(r)[0].dataset.serviceid;NaN!=a&&-1===sIDs.indexOf(a)&&r.remove()}),$(".departureEntry.empty").remove();rows<rowsPerPage;)$(".departuresList").append('<div class="departureEntry empty"><div class="departureRow"><p class="delayReason">&nbsp;</p></div></div>'),rows++;for(;rows>rowsPerPage;)$(".departureEntry.empty").length>0&&$(".departuresList").find(".departureEntry.empty")[0].remove(),rows--;"function"==typeof e&&e()})}var sync=setInterval(function(){!1===responseError&&getSecs()%10==0?(clearInterval(sync),x=setInterval(getTrains,1e4)):responseError&&clearInterval(sync)},100),departuresDetailed=new Object;function getTrainsDetailed(e){$.get("php/getDeparturesDetailed.php?station="+stationCode+"&rows="+departures,function(r){$.each(r,function(e,r){departuresDetailed[sanitizeID(r.serviceID)]=r}),$.each(departuresDetailed,function(e){0===$("#"+e).length&&delete departuresDetailed[e]}),"function"==typeof e&&e()})}function checkDepartures(){$(".departureEntry:not(.empty, .error)").each(function(){var e=$(this).find(".std").text(),r=$(this).find(".etd").text();if(e===getHM(5)&&"On time"==r){var a=$(this).attr("id"),t=$(this).find(".platform").text(),s=$(this).find(".destinationName").text(),n=$(this).data("operator");if(void 0!==departuresDetailed[a]){var i="",o=0;$.each(departuresDetailed[a].subsequentCallingPoints,function(e,r){if(Array.isArray(r))$.each(r,function(e,a){var t=a.callingPoint.length,s=0;$.each(a.callingPoint,function(e,r){s>0&&s!=t-1?i+=", ":s===t-1&&(i+=", and "),i+=r.locationName,s++}),o!=r.length-1&&(i+=", and "),o++});else if(Array.isArray(r.callingPoint)){var a=r.callingPoint.length,t=0;$.each(r.callingPoint,function(e,r){t>0&&t!=a-1?i+=", ":t===a-1&&(i+=", and "),i+=r.locationName,t++})}else i+=r.callingPoint.locationName+" only."}),speakService(t,e,n,s,i)}else speakService(t,e,n,s,null)}})}function speakService(e,r,a,t,s){text=null!=s?"Platform "+e+" for the "+r+" "+a+" service to "+t+", calling at: "+s:"Platform "+e+" for the "+r+" "+a+" service to "+t,speak(text,1,.85,.8)}"true"===getQueryVariable("speak")?(getTrains(function(){getTrainsDetailed(function(){checkDepartures()})}),setInterval(getTrainsDetailed,6e4),setInterval(checkDepartures,6e4)):getTrains();