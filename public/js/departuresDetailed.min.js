if(getQueryVariable("screen"))var screen=getQueryVariable("screen");else screen=1;var r,altNames,calRows,aDN,responseError=!1,stationCode=getQueryVariable("station"),maxRows=17,trainSplits=[];function getTrains(e){$.get("assets/getDeparturesDetailedTest1.json",function(t){if(trainSplits=[],r=t,$(".departureEntry.error, .departureEntry.noDepartures").remove(),"No response"===t)rows+=3,responseError=!0,$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">No reponse recieved.</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">Check station code is correct</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">and rate limit is not exceeded.</p></div></div>');else if("No departures"===t)rows++,0===$(".noDepartures").length&&$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre">No departures</p></div></div>');else if(t.length>0){if($(".main").removeClass("changed"),service=t[screen-1],$(".main").attr("id")!=sanitizeID(service.serviceID)&&($(".main").attr("id",sanitizeID(service.serviceID)).addClass("changed"),e=scrollServiceInfo),$(".departuresList .departureTime").html(service.std),$(".departuresList .departureTimeEstimated").html(service.etd),null!=service.platform&&"TBC"!=service.platform?($(".departuresList .platform").html("Plat "+service.platform),$(".headingRight.timePlat").addClass("animate")):($(".departuresList .platform").html(""),$(".headingRight.timePlat").removeClass("animate")),null!=service.destination.location)if(destinationName="",service.destination.location.length>1){var a=0;$.each(service.destination.location,function(e,t){0!=a&&(destinationName+=" &amp; "),destinationName+=t.locationName,a++})}else null!=altNames[service.destination.location.crs]?destinationName+=altNames[service.destination.location.crs]:destinationName+=service.destination.location.locationName;$(".departuresList .destinationName").data("name")!=destinationName&&($(".departuresList .destinationName").data("name",destinationName),clearInterval(aDN),splitDestName(destinationName)),$(".calling .departureEntry").remove(),calRows=0,Array.isArray(service.subsequentCallingPoints.callingPointList)?$.each(service.subsequentCallingPoints.callingPointList,function(e,t){calRows=0,callingPoints(t.callingPoint)}):callingPoints(service.subsequentCallingPoints.callingPointList.callingPoint),callingListAnimation();var i="";if(isVowel(service.operator[0])?i+="An ":i+="A ",i+=service.operator+" service.",trainSplits.length>0){i+=" This service divides at ";var s=trainSplits.length;$.each(trainSplits,function(e,t){i+=t,e+1!=s&&(i+=" ")}),i+="."}$(".departuresList .serviceInformation").html(i)}"function"==typeof e&&e()})}function callingPoints(e){if(Array.isArray(e)){var t=e.length;$.each(e,function(e,a){if(calRows++,0===$("#"+a.crs+sanitizeID(a.st)).length){var i="";i+='<div class="departureEntry '+(e+1)+'" id="'+a.crs+sanitizeID(a.st)+'"><div class="callingRow">',i+='<p class="callingLocation">',calRows===t&&(i+="& "),null!=altNames[a.crs]?i+=altNames[a.crs]:i+=a.locationName,i+="</p>","On time"==a.et?i+='<p class="callingTime">('+a.st+")</p>":"Delayed"!=a.et&&(i+='<p class="callingTime">('+a.et+")</p>"),i+="</div></div>",$(".departuresList .calling").append(i)}else trainSplits.push(a.locationName)})}else{var a=e;if(0===$("#"+a.crs+sanitizeID(a.st)).length){var i="";i+='<div class="departureEntry" id="'+a.crs+sanitizeID(a.st)+'"><div class="callingRow">',null!=altNames[a.crs]?i+='<p class="callingLocation">'+altNames[a.crs]+"</p>":i+='<p class="callingLocation">'+a.locationName+"</p>","On time"==a.et?i+='<p class="callingTime">('+a.st+")</p>":i+='<p class="callingTime">('+a.et+")</p>",i+="</div></div>",$(".departuresList .calling").append(i)}calRows++}}function scrollServiceInfo(){console.log("ssi");var e=$(".serviceInformation");e.outerWidth()>e.parent().width()?(e.css("left","1000px"),scrollAnimation(e,.2,scrollServiceInfo)):e.css("transition","").css("left","0")}$.get("assets/alternativeStationNames.json",function(e){altNames=e.alternativeNames});var cLA,aniDestI=1;function splitDestName(e){var t=splitString(20,e),a="";$.each(t,function(e,t){a+="<p>"+t+"</p>"}),$(".departuresList .destinationName").html(a),t.length>1&&(aDN=setInterval(animateDestName,5e3))}function animateDestName(){aniDestI>$(".departuresList .destinationName p").length&&(aniDestI=1),$(".departuresList .destinationName p").hide(),$(".departuresList .destinationName p:nth-child("+aniDestI+")").show(),aniDestI++}var calRowsVisible,cPage=1;function callingListAnimation(){var e=$(".calling .departureEntry:not(.empty)").length;for(e>maxRows?($(".callingPage").text("Page "+cPage+" of "+Math.ceil(e/maxRows)),$(".calling .departureEntry").addClass("hidden"),$(".calling .departureEntry:gt("+maxRows*(cPage-1)+"), .calling .departureEntry:eq("+maxRows*(cPage-1)+")").removeClass("hidden"),$(".calling .departureEntry:gt("+(maxRows*cPage-1)+")").addClass("hidden"),++cPage>Math.ceil(e/maxRows)&&(cPage=1)):(cPage=1,$(".callingPage").text("Page "+cPage+" of "+Math.ceil(e/maxRows))),calRowsVisible=$(".calling .departureEntry:not(.hidden)").length;calRowsVisible<maxRows;)$(".departuresList .calling").append('<div class="departureEntry empty"><div class="callingRow"><p>&nbsp;</p></div></div>'),calRowsVisible++}var sync=setInterval(function(){!1===responseError&&getSecs()%10==0?(clearInterval(sync),setInterval(getTrains,1e4)):responseError&&clearInterval(sync)},100),departuresDetailed=new Object;function getTrainsDetailed(e){$.get("php/getDeparturesDetailed.php?station="+stationCode+"&rows="+departures,function(t){$.each(t,function(e,t){departuresDetailed[sanitizeID(t.serviceID)]=t}),$.each(departuresDetailed,function(e){0===$("#"+e).length&&delete departuresDetailed[e]}),"function"==typeof e&&e()})}function checkDepartures(){$(".departureEntry:not(.empty, .error)").each(function(){var e=$(this).find(".std").text(),t=$(this).find(".etd").text();if(e===getHM(5)&&"On time"==t){var a=$(this).attr("id"),i=$(this).find(".platform").text(),s=$(this).find(".destinationName").text(),n=$(this).data("operator");if(void 0!==departuresDetailed[a]){var r="",l=0;$.each(departuresDetailed[a].subsequentCallingPoints,function(e,t){if(Array.isArray(t))$.each(t,function(e,a){var i=a.callingPoint.length,s=0;$.each(a.callingPoint,function(e,t){s>0&&s!=i-1?r+=", ":s===i-1&&(r+=", and "),r+=t.locationName,s++}),l!=t.length-1&&(r+=", and "),l++});else if(Array.isArray(t.callingPoint)){var a=t.callingPoint.length,i=0;$.each(t.callingPoint,function(e,t){i>0&&i!=a-1?r+=", ":i===a-1&&(r+=", and "),r+=t.locationName,i++})}else r+=t.callingPoint.locationName+" only."}),speakService(i,e,n,s,r)}else speakService(i,e,n,s,null)}})}"true"===getQueryVariable("speak")?(getTrains(function(){scrollServiceInfo(),getTrainsDetailed(function(){checkDepartures()})}),setInterval(getTrainsDetailed,6e4),setInterval(checkDepartures,6e4)):getTrains(scrollServiceInfo);