function getTrains(a){sIDs=[],rows=0;var b=0;$.get("php/getDepartures.php?station="+stationCode+"&rows="+departures,function(c){for("No response"===c?(rows+=3,responseError=!0,$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">No reponse recieved.</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">Check station code is correct</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">and rate limit is not exceeded.</p></div></div>')):"No departures"===c?(rows++,0===$(".noDepartures").length&&$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre">No departures</p></div></div>')):c.length>0&&$.each(c,function(a,c){if(b++,b<=rowsPerPage*(page-1));else{if(b>rowsPerPage*page)return!1;var d=sanitizeID(c.serviceID);if(rows++,sIDs.push(c.serviceID),0===$("#"+d).length){var e='<div class="departureEntry" id="'+d+'" data-serviceID="'+c.serviceID+'" data-operator="'+c.operator+'">';if(e+='<div class="departureRow">',e+='<p class="std">',null!=c.std&&(e+=c.std),e+="</p>",e+='<p class="destinationName">',null!=c.destination.location)if(c.destination.location.length>1){var f=0;$.each(c.destination.location,function(a,b){0!=f&&(e+=" &amp; "),e+='<a href="?station='+b.crs+'">'+b.locationName+"</a>",f++})}else e+='<a href="?station='+c.destination.location.crs+'">'+c.destination.location.locationName+"</a>";e+="</p>",e+='<p class="platform">',"train"!=c.serviceType?e+=c.serviceType:null!=c.platform&&(e+=c.platform),e+="</p>",e+='<p class="etd">',null!=c.etd&&(e+=c.etd),e+="</p>",e+="</div>",e+="</div>",$(".departuresList").append(e)}else{var g=$("#"+d),h="";if(null!=c.destination.location)if(h="",c.destination.location.length>1){var f=0;$.each(c.destination.location,function(a,b){0!=f&&(h+=" &amp; "),h+='<a href="?station='+b.crs+'">'+b.locationName+"</a>",f++})}else h+='<a href="?station='+c.destination.location.crs+'">'+c.destination.location.locationName+"</a>";$(g).find(".destinationName").html()!=h.replace(" & "," &amp; ")&&$(g).find(".destinationName").html(h).addClass("departureUpdated"),h="","train"!=c.serviceType?h=c.serviceType:null!=c.platform&&(h=c.platform),$(g).find(".platform").html()!=h&&$(g).find(".platform").html(h).addClass("departureUpdated"),h="",null!=c.etd&&(h=c.etd),$(g).find(".etd").html()!=h&&$(g).find(".etd").html(h)}}}),$.each($(".departureEntry:not(.empty, .error, .noDepartures)"),function(a,b){var c=$(b)[0].dataset.serviceid;NaN!=c&&sIDs.indexOf(c)===-1&&b.remove()}),$(".departureEntry.empty").remove();rows<rowsPerPage;)$(".departuresList").append('<div class="departureEntry empty"><div class="departureRow"><p class="delayReason">&nbsp;</p></div></div>'),rows++;for(;rows>rowsPerPage;)$(".departureEntry.empty").length>0&&$(".departuresList").find(".departureEntry.empty")[0].remove(),rows--;var d=Math.ceil(c.length/rowsPerPage);$(".page").text("Page "+page+" of "+d),"function"==typeof a&&a()})}function getTrainsDetailed(a){$.get("php/getDeparturesDetailed.php?station="+stationCode+"&rows="+departures,function(b){$.each(b,function(a,b){departuresDetailed[sanitizeID(b.serviceID)]=b}),$.each(departuresDetailed,function(a){0===$("#"+a).length&&delete departuresDetailed[a]}),"function"==typeof a&&a()})}function checkDepartures(){$(".departureEntry:not(.empty, .error)").each(function(){var a=$(this).find(".std").text(),b=$(this).find(".etd").text();if(a===getHM(5)&&"On time"==b){var c=$(this).attr("id"),d=$(this).find(".platform").text(),e=$(this).find(".destinationName").text(),f=$(this).data("operator");if("undefined"!=typeof departuresDetailed[c]){var g="",h=0;$.each(departuresDetailed[c].subsequentCallingPoints,function(a,b){if(Array.isArray(b))$.each(b,function(a,c){var d=c.callingPoint.length,e=0;$.each(c.callingPoint,function(a,b){e>0&&e!=d-1?g+=", ":e===d-1&&(g+=", and "),g+=b.locationName,e++}),h!=b.length-1&&(g+=", and "),h++});else if(Array.isArray(b.callingPoint)){var c=b.callingPoint.length,d=0;$.each(b.callingPoint,function(a,b){d>0&&d!=c-1?g+=", ":d===c-1&&(g+=", and "),g+=b.locationName,d++})}else g+=b.callingPoint.locationName+" only."}),speakService(d,a,f,e,g)}else speakService(d,a,f,e,null)}})}function speakService(a,b,c,d,e){null!=e?text="Platform "+a+" for the "+b+" "+c+" service to "+d+", calling at: "+e:text="Platform "+a+" for the "+b+" "+c+" service to "+d,speak(text,1,.85,.8)}var sIDs=[],rowsPerPage=27,pages=5,departures=rowsPerPage*pages;if(getQueryVariable("page"))var page=getQueryVariable("page");else var page=1;var rows,stationCode=getQueryVariable("station"),responseError=!1,sync=setInterval(function(){responseError===!1&&getSecs()%10===0?(clearInterval(sync),setInterval(getTrains,1e4)):responseError&&clearInterval(sync)},100),departuresDetailed=new Object;"true"===getQueryVariable("speak")?(getTrains(function(){getTrainsDetailed(function(){checkDepartures()})}),setInterval(getTrainsDetailed,6e4),setInterval(checkDepartures,6e4)):getTrains();