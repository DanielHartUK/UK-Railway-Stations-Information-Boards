function getTrains(a){$.get("assets/getDeparturesDetailedTest1.json",function(b){if(trainSplits=[],r=b,$(".departureEntry.error, .departureEntry.noDepartures").remove(),"No response"===b)rows+=3,responseError=!0,$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">No reponse recieved.</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">Check station code is correct</p></div></div>'),$(".departuresList").append('<div class="departureEntry error"><div class="departureRow"><p class="errorMessage">and rate limit is not exceeded.</p></div></div>');else if("No departures"===b)rows++,0===$(".noDepartures").length&&$(".departuresList").append('<div class="departureEntry noDepartures"><div class="departureRow"><p class="errorMessage centre">No departures</p></div></div>');else if(b.length>0){if(service=b[screen-1],$(".main").attr("id",sanitizeID(service.serviceID))!=sanitizeID(service.serviceID)&&$(".main").attr("id",sanitizeID(service.serviceID)),$(".departuresList .departureTime").html(service.std),$(".departuresList .departureTimeEstimated").html(service.etd),null!=service.platform&&"TBC"!=service.platform?($(".departuresList .platform").html("Plat "+service.platform),$(".headingRight.timePlat").addClass("animate")):($(".departuresList .platform").html(""),$(".headingRight.timePlat").removeClass("animate")),null!=service.destination.location)if(destinationName="",service.destination.location.length>1){var c=0;$.each(service.destination.location,function(a,b){0!=c&&(destinationName+=" &amp; "),destinationName+=b.locationName,c++})}else null!=altNames[service.destination.location.crs]?destinationName+=altNames[service.destination.location.crs]:destinationName+=service.destination.location.locationName;$(".departuresList .destinationName").data("name")!=destinationName&&($(".departuresList .destinationName").data("name",destinationName),clearInterval(aDN),splitDestName(destinationName)),$(".calling .departureEntry").remove(),calRows=0,Array.isArray(service.subsequentCallingPoints.callingPointList)?$.each(service.subsequentCallingPoints.callingPointList,function(a,b){calRows=0,callingPoints(b.callingPoint)}):callingPoints(service.subsequentCallingPoints.callingPointList.callingPoint),callingListAnimation();var d="";if(d+=isVowel(service.operator[0])?"An ":"A ",d+=service.operator+" service.",trainSplits.length>0){d+=" This service divides at ";var e=trainSplits.length;$.each(trainSplits,function(a,b){d+=b,a+1!=e&&(d+=" ")}),d+="."}$(".departuresList .serviceInformation").html(d)}"function"==typeof a&&a()})}function callingPoints(a){if(Array.isArray(a)){var b=a.length;$.each(a,function(a,c){if(calRows++,0===$("#"+c.crs+sanitizeID(c.st)).length){var d="";d+='<div class="departureEntry '+(a+1)+'" id="'+c.crs+sanitizeID(c.st)+'"><div class="callingRow">',d+='<p class="callingLocation">',calRows===b&&(d+="& "),d+=null!=altNames[c.crs]?altNames[c.crs]:c.locationName,d+="</p>","On time"==c.et?d+='<p class="callingTime">('+c.st+")</p>":"Delayed"!=c.et&&(d+='<p class="callingTime">('+c.et+")</p>"),d+="</div></div>",$(".departuresList .calling").append(d)}else trainSplits.push(c.locationName)})}else{var c=a;if(0===$("#"+c.crs+sanitizeID(c.st)).length){var d="";d+='<div class="departureEntry" id="'+c.crs+sanitizeID(c.st)+'"><div class="callingRow">',d+=null!=altNames[c.crs]?'<p class="callingLocation">'+altNames[c.crs]+"</p>":'<p class="callingLocation">'+c.locationName+"</p>",d+="On time"==c.et?'<p class="callingTime">('+c.st+")</p>":'<p class="callingTime">('+c.et+")</p>",d+="</div></div>",$(".departuresList .calling").append(d)}calRows++}}function splitDestName(a){var b=splitString(20,a);console.log(b.length);var c="";$.each(b,function(a,b){c+="<p>"+b+"</p>"}),$(".departuresList .destinationName").html(c),b.length>1&&(aDN=setInterval(animateDestName,5e3))}function animateDestName(){aniDestI>$(".departuresList .destinationName p").length&&(aniDestI=1),$(".departuresList .destinationName p").hide(),$(".departuresList .destinationName p:nth-child("+aniDestI+")").show(),aniDestI++}function callingListAnimation(){var a=$(".calling .departureEntry:not(.empty)").length;for(console.log(a),a>maxRows?($(".callingPage").text("Page "+cPage+" of "+Math.ceil(a/maxRows)),$(".calling .departureEntry").addClass("hidden"),$(".calling .departureEntry:gt("+maxRows*(cPage-1)+"), .calling .departureEntry:eq("+maxRows*(cPage-1)+")").removeClass("hidden"),$(".calling .departureEntry:gt("+(maxRows*cPage-1)+")").addClass("hidden"),cPage++,cPage>Math.ceil(a/maxRows)&&(cPage=1)):$(".callingPage").text("Page "+cPage+" of "+Math.ceil(a/maxRows)),calRowsVisible=$(".calling .departureEntry:not(.hidden)").length;calRowsVisible<maxRows;)$(".departuresList .calling").append('<div class="departureEntry empty"><div class="callingRow"><p>&nbsp;</p></div></div>'),calRowsVisible++}function getTrainsDetailed(a){$.get("php/getDeparturesDetailed.php?station="+stationCode+"&rows="+departures,function(b){$.each(b,function(a,b){departuresDetailed[sanitizeID(b.serviceID)]=b}),$.each(departuresDetailed,function(a){0===$("#"+a).length&&delete departuresDetailed[a]}),"function"==typeof a&&a()})}function checkDepartures(){$(".departureEntry:not(.empty, .error)").each(function(){var a=$(this).find(".std").text(),b=$(this).find(".etd").text();if(a===getHM(5)&&"On time"==b){var c=$(this).attr("id"),d=$(this).find(".platform").text(),e=$(this).find(".destinationName").text(),f=$(this).data("operator");if("undefined"!=typeof departuresDetailed[c]){var g="",h=0;$.each(departuresDetailed[c].subsequentCallingPoints,function(a,b){if(Array.isArray(b))$.each(b,function(a,c){var d=c.callingPoint.length,e=0;$.each(c.callingPoint,function(a,b){e>0&&e!=d-1?g+=", ":e===d-1&&(g+=", and "),g+=b.locationName,e++}),h!=b.length-1&&(g+=", and "),h++});else if(Array.isArray(b.callingPoint)){var c=b.callingPoint.length,d=0;$.each(b.callingPoint,function(a,b){d>0&&d!=c-1?g+=", ":d===c-1&&(g+=", and "),g+=b.locationName,d++})}else g+=b.callingPoint.locationName+" only."}),speakService(d,a,f,e,g)}else speakService(d,a,f,e,null)}})}function speakService(a,b,c,d,e){null!=e?text="Platform "+a+" for the "+b+" "+c+" service to "+d+", calling at: "+e:text="Platform "+a+" for the "+b+" "+c+" service to "+d,speak(text,1,.85,.8)}if(getQueryVariable("screen"))var screen=getQueryVariable("screen");else var screen=1;var responseError=!1,stationCode=getQueryVariable("station"),r,altNames,maxRows=17,calRows,trainSplits=[];$.get("assets/alternativeStationNames.json",function(a){altNames=a.alternativeNames});var aDN,aniDestI=1,cLA,cPage=1,calRowsVisible,sync=setInterval(function(){responseError===!1&&getSecs()%10===0?clearInterval(sync):responseError&&clearInterval(sync)},100),departuresDetailed=new Object;"true"===getQueryVariable("speak")?(getTrains(function(){getTrainsDetailed(function(){checkDepartures()})}),setInterval(getTrainsDetailed,6e4),setInterval(checkDepartures,6e4)):getTrains();